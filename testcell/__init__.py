__version__ = "0.0.6"
# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/02_testcell.ipynb.

# %% auto 0
__all__ = ['testcell_valid_args', 'TestcellArgs', 'Code', 'parse_args', 'parse_testcell_args', 'testcell', 'testcelln']

# %% ../nbs/02_testcell.ipynb 4
import ast
from IPython.core.magic import register_cell_magic, needs_local_scope
from IPython import get_ipython # needed for quarto
from collections import namedtuple

# %% ../nbs/02_testcell.ipynb 6
from pygments.formatters import HtmlFormatter
from pygments import highlight
from pygments.lexers import PythonLexer
from IPython.display import HTML

def Code(data=None, url=None, filename=None, language=None):
    return HTML(highlight(data, PythonLexer(), HtmlFormatter(full=True)))

# %% ../nbs/02_testcell.ipynb 7
from .core import auto_return
from .inout import separate_args_and_inout, process_inout, split_and_strip, validate_and_update_inputs

# %% ../nbs/02_testcell.ipynb 10
testcell_valid_args = {'verbose','dryrun','noglobals','noreturn','debug'} # set!

# %% ../nbs/02_testcell.ipynb 11
def parse_args(x):
    t = set([c for c in split_and_strip(x,' ') if c != ''])
    diff = t.difference(testcell_valid_args)
    if len(diff)>0: raise ValueError(f'Invalid arguments passed: "{",".join(diff)}"')
    return t

# %% ../nbs/02_testcell.ipynb 14
TestcellArgs = namedtuple('TestcellArgs','args inout')

# %% ../nbs/02_testcell.ipynb 15
def parse_testcell_args(x):
    raw_args,raw_inout = separate_args_and_inout(x)
    return TestcellArgs(parse_args(raw_args),process_inout(raw_inout))

# %% ../nbs/02_testcell.ipynb 18
@register_cell_magic
@needs_local_scope
def testcell(line, cell, local_ns):
    args,inout = parse_testcell_args(line)
    
    # Parse arguments
    verbose = 'verbose' in args # enable verbose 
    dryrun = 'dryrun' in args # this will avoid running the code and just print out the code like verbose
    noglobals = 'noglobals' in args # no access to global variables, this enables 'noreturn' too 
    noreturn = 'noreturn' in args # display but does not return anything, so no memory "footprint" after execution
    debug = 'debug' in args
    
    # arguments rules
    if noglobals or dryrun: noreturn=True
    if dryrun: verbose=True
    if debug: verbose=True
    
    # Do the job
    cell = auto_return(cell)
    lines = cell.splitlines()

    # Globals management
    _globals = {} if noglobals else local_ns
    _locals = {'_':None} if noreturn else None # we mask '_' with a local variable to prevent it affecting global scope
    
    outputs = None
    globals_definitions = []
    if inout is not None:
        inputs,outputs = inout
        # inputs
        _globals.update(validate_and_update_inputs(inputs,local_ns))
        # outputs
        for o in outputs: globals_definitions += ['\t'+f'global {o}']

    # Wrap inside a function and execute it
    arr = ['def _test_cell_():']
    arr += globals_definitions
    arr += ['\t'+x for x in lines]
    arr += ['try:\n\t_ = _test_cell_()'] # execute it and assign result to '_'
    arr += ['finally:\n\tdel _test_cell_'] # delete it
    if noreturn:
        arr += ['if _ is not None: display(_)'] # having this as last line makes the same behavior as normal cell        
    else:
        arr += ['_ # This will be added to global scope'] # having this as last line makes the same behavior as normal cell
    wrapped_cell = '\n'.join(arr)
    
    if verbose: display(Code('\n### BEGIN\n'+wrapped_cell+'\n### END',language='python'))
        
    if not dryrun: exec(wrapped_cell,_globals,_locals)
        
    if (outputs is not None) and (len(outputs)>0) and (not dryrun):
        arr2 = []
        for o in outputs: arr2 += [f'global {o}; {o}=locals()["{o}"]'] # this forwards objects to global scope
        globals_update_code = '\n'.join(arr2)
        if debug: display(Code('\n### GLOBALS UPDATE CODE:\n'+globals_update_code+'\n###',language='python'))
        exec(globals_update_code,local_ns,_globals)
        
    
    return None if noreturn else _globals.get('_',None) # this closes the loop of integration

# %% ../nbs/02_testcell.ipynb 22
@register_cell_magic
@needs_local_scope
def testcelln(line, cell, local_ns):
    return testcell(line=line+ ' noglobals', cell=cell, local_ns=local_ns)
